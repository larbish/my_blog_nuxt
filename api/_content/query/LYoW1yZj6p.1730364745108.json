{"_path":"/articles/dvwa-commandinjection","_dir":"articles","_draft":false,"_partial":false,"_locale":"","title":"DVWA靶场记录-Command Injection","description":"在DVWA靶场学习使用Command Injection 命令注入","time":"2024-9-15","body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"写在前面"},"children":[{"type":"text","value":"写在前面"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"开始攻击前简单学习一下 Command Injection 命令注入。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"命令注入指的是通过web程序的漏洞实现执行服务器命令。有些web页面可能会调用系统命令执行一些操作，如果对输入的内容没有执行严格过滤，就会导致漏洞出现，从而实现命令注入。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"开始攻击前介绍四个命令拼接符。"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"&&: 先执行 command1且执行成功再执行 command2"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"&   : 先执行 command1 不管是否成功都执行 command2"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"||  : 先执行 command1 且执行失败再执行 command2"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"|    : 先执行 command1 再将 command1 的输出作为 command2 的输入，最后只输出 command2 的结果"}]}]},{"type":"element","tag":"h1","props":{"id":"low-等级"},"children":[{"type":"text","value":"low 等级"}]},{"type":"element","tag":"pre","props":{"className":"language-php shiki shiki-themes github-dark","code":"<?php\n\nif( isset( $_POST[ 'Submit' ]  ) ) {\n    // 获取输入\n    $target = $_REQUEST[ 'ip' ];\n\n    // 判断操作系统，并执行ping命令\n    if( stristr( php_uname( 's' ), 'Windows NT' ) ) {\n        // Windows\n        $cmd = shell_exec( 'ping  ' . $target );\n    }\n    else {\n        // *nix\n        $cmd = shell_exec( 'ping  -c 4 ' . $target );\n    }\n\n    // 最后输出的内容\n    echo \"<pre>{$cmd}</pre>\";\n}\n","language":"php","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"<?php\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"if( isset( $_POST[ 'Submit' ]  ) ) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    // 获取输入\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    $target = $_REQUEST[ 'ip' ];\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    // 判断操作系统，并执行ping命令\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    if( stristr( php_uname( 's' ), 'Windows NT' ) ) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        // Windows\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        $cmd = shell_exec( 'ping  ' . $target );\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    else {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        // *nix\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        $cmd = shell_exec( 'ping  -c 4 ' . $target );\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    // 最后输出的内容\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    echo \"<pre>{$cmd}</pre>\";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"通过检查代码，我们可以发现low等级并没有任何防护措施，只是将输入框的内容放到函数中直接执行，以此我们可以随意让服务器执行命令。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"3","src":"/image/DVWA-CommandInjection/3.webp"},"children":[]}]},{"type":"element","tag":"h1","props":{"id":"medium-等级"},"children":[{"type":"text","value":"Medium 等级"}]},{"type":"element","tag":"pre","props":{"className":"language-php shiki shiki-themes github-dark","code":"<?php\n\nif( isset( $_POST[ 'Submit' ]  ) ) {\n    // 获取输入\n    $target = $_REQUEST[ 'ip' ];\n\n    // 设置黑名单\n    $substitutions = array(\n        '&&' => '',\n        ';'  => '',\n    );\n\n    // 删除黑名单中的字符\n    $target = str_replace( array_keys( $substitutions ), $substitutions, $target );\n\n    // 判断操作系统，并执行ping命令\n    if( stristr( php_uname( 's' ), 'Windows NT' ) ) {\n        // Windows\n        $cmd = shell_exec( 'ping  ' . $target );\n    }\n    else {\n        // *nix\n        $cmd = shell_exec( 'ping  -c 4 ' . $target );\n    }\n\n    // 最后输出的内容\n    echo \"<pre>{$cmd}</pre>\";\n}\n\n?>\n","language":"php","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"<?php\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"if( isset( $_POST[ 'Submit' ]  ) ) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    // 获取输入\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    $target = $_REQUEST[ 'ip' ];\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    // 设置黑名单\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    $substitutions = array(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        '&&' => '',\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        ';'  => '',\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    );\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    // 删除黑名单中的字符\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    $target = str_replace( array_keys( $substitutions ), $substitutions, $target );\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    // 判断操作系统，并执行ping命令\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    if( stristr( php_uname( 's' ), 'Windows NT' ) ) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        // Windows\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        $cmd = shell_exec( 'ping  ' . $target );\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    else {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        // *nix\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        $cmd = shell_exec( 'ping  -c 4 ' . $target );\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    // 最后输出的内容\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    echo \"<pre>{$cmd}</pre>\";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"?>\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Medium 等级添加了黑名单功能，但是黑名单内容只有 && 和 ; ，所以我们仍可以使用 & 、|| 和 |。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"3","src":"/image/DVWA-CommandInjection/3.webp"},"children":[]}]},{"type":"element","tag":"h1","props":{"id":"high-等级"},"children":[{"type":"text","value":"High 等级"}]},{"type":"element","tag":"pre","props":{"className":"language-php shiki shiki-themes github-dark","code":"<?php\n\nif( isset( $_POST[ 'Submit' ]  ) ) {\n    // 获取输入\n    $target = trim($_REQUEST[ 'ip' ]);\n\n    // 设置黑名单\n    $substitutions = array(\n        '&'  => '',\n        ';'  => '',\n        '| ' => '',\n        '-'  => '',\n        '$'  => '',\n        '('  => '',\n        ')'  => '',\n        '`'  => '',\n        '||' => '',\n    );\n\n    // 删除黑名单中的字符\n    $target = str_replace( array_keys( $substitutions ), $substitutions, $target );\n\n    // 判断操作系统，并执行ping命令\n    if( stristr( php_uname( 's' ), 'Windows NT' ) ) {\n        // Windows\n        $cmd = shell_exec( 'ping  ' . $target );\n    }\n    else {\n        // *nix\n        $cmd = shell_exec( 'ping  -c 4 ' . $target );\n    }\n\n    // 最后输出的内容\n    echo \"<pre>{$cmd}</pre>\";\n}\n\n?>\n","language":"php","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"<?php\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"if( isset( $_POST[ 'Submit' ]  ) ) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    // 获取输入\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    $target = trim($_REQUEST[ 'ip' ]);\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    // 设置黑名单\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    $substitutions = array(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        '&'  => '',\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        ';'  => '',\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        '| ' => '',\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        '-'  => '',\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        '$'  => '',\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        '('  => '',\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        ')'  => '',\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        '`'  => '',\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        '||' => '',\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    );\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    // 删除黑名单中的字符\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    $target = str_replace( array_keys( $substitutions ), $substitutions, $target );\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    // 判断操作系统，并执行ping命令\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    if( stristr( php_uname( 's' ), 'Windows NT' ) ) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        // Windows\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        $cmd = shell_exec( 'ping  ' . $target );\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    else {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        // *nix\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        $cmd = shell_exec( 'ping  -c 4 ' . $target );\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    // 最后输出的内容\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    echo \"<pre>{$cmd}</pre>\";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":37},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"?>\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"High等级只是在原有的基础多添加了几个黑名单项，看上去貌似无法破解了，但是仔细观察会发现 | 后面有一个空格，因此我们还是可以使用 | 作为拼接符。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"3","src":"/image/DVWA-CommandInjection/3.webp"},"children":[]}]},{"type":"element","tag":"h1","props":{"id":"impossible-等级"},"children":[{"type":"text","value":"Impossible 等级"}]},{"type":"element","tag":"pre","props":{"className":"language-php shiki shiki-themes github-dark","code":"<?php\n\nif( isset( $_POST[ 'Submit' ]  ) ) {\n    // 检查CSRF令牌以防止跨站请求伪造攻击\n    checkToken( $_REQUEST[ 'user_token' ], $_SESSION[ 'session_token' ], 'index.php' );\n\n    // 获取输入\n    $target = $_REQUEST[ 'ip' ];\n    // 移出反斜杠\n    $target = stripslashes( $target );\n\n    // 将IP切割为四份\n    $octet = explode( \".\", $target );\n\n    // 检查是否为int\n    if( ( is_numeric( $octet[0] ) ) && ( is_numeric( $octet[1] ) ) && ( is_numeric( $octet[2] ) ) && ( is_numeric( $octet[3] ) ) && ( sizeof( $octet ) == 4 ) ) {\n        // 如果都是int就重新拼接\n        $target = $octet[0] . '.' . $octet[1] . '.' . $octet[2] . '.' . $octet[3];\n\n        // 判断操作系统，并执行ping命令\n        if( stristr( php_uname( 's' ), 'Windows NT' ) ) {\n            // Windows\n            $cmd = shell_exec( 'ping  ' . $target );\n        }\n        else {\n            // *nix\n            $cmd = shell_exec( 'ping  -c 4 ' . $target );\n        }\n\n        // 最后输出的内容\n        echo \"<pre>{$cmd}</pre>\";\n    }\n    else {\n        // 告诉用户输入有错\n        echo '<pre>ERROR: You have entered an invalid IP.</pre>';\n    }\n}\n\n// 生成会话CSRF令牌\ngenerateSessionToken();\n\n?>\n","language":"php","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"<?php\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"if( isset( $_POST[ 'Submit' ]  ) ) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    // 检查CSRF令牌以防止跨站请求伪造攻击\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    checkToken( $_REQUEST[ 'user_token' ], $_SESSION[ 'session_token' ], 'index.php' );\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    // 获取输入\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    $target = $_REQUEST[ 'ip' ];\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    // 移出反斜杠\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    $target = stripslashes( $target );\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    // 将IP切割为四份\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    $octet = explode( \".\", $target );\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    // 检查是否为int\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    if( ( is_numeric( $octet[0] ) ) && ( is_numeric( $octet[1] ) ) && ( is_numeric( $octet[2] ) ) && ( is_numeric( $octet[3] ) ) && ( sizeof( $octet ) == 4 ) ) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        // 如果都是int就重新拼接\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        $target = $octet[0] . '.' . $octet[1] . '.' . $octet[2] . '.' . $octet[3];\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        // 判断操作系统，并执行ping命令\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        if( stristr( php_uname( 's' ), 'Windows NT' ) ) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"            // Windows\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"            $cmd = shell_exec( 'ping  ' . $target );\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        else {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"            // *nix\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"            $cmd = shell_exec( 'ping  -c 4 ' . $target );\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        // 最后输出的内容\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        echo \"<pre>{$cmd}</pre>\";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    else {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        // 告诉用户输入有错\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"        echo '<pre>ERROR: You have entered an invalid IP.</pre>';\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":37},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":38},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":39},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"// 生成会话CSRF令牌\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":40},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"generateSessionToken();\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":41},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":42},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"?>\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Impossible 等级去掉了黑名单，修改成对用户输入的判断，判断是否符合ip地址的格式。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"这样相当于从黑名单转换成白名单，这样就可以避免黑名单项的错误，也让命令注入变成无法实现的了。"}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[]}},"_type":"markdown","_id":"content:articles:DVWA-CommandInjection.md","_source":"content","_file":"articles/DVWA-CommandInjection.md","_stem":"articles/DVWA-CommandInjection","_extension":"md"}